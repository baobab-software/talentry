generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
  output     = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


// ========== ENUMS ==========
enum UserRole {
  ADMIN
  SEEKER
  COMPANY
}

enum AdminType {
  SUPER_ADMIN
  COMPANY_ADMIN
}

enum CompanyMemberRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

enum CompanyMemberStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum InvitationType {
  COMPANY_MEMBER
  ADMIN_USER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
  REVOKED
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}

// ========== MODELS ==========
model User {
  id        String   @id @default(cuid())
  avatar    String?
  email     String   @unique
  phone     String   @unique
  image     String?
  role      UserRole @default(SEEKER)
  password String
  emailVerified Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  admin               Admin?
  seeker              Seeker?
  company             Company?
  companyMembers      CompanyMember[]
  memberInvitations   CompanyMember[]      @relation("MemberInviter")
  invitationsSent     Invitation[]         @relation("Inviter")
  invitationsReceived Invitation[]         @relation("Invitee")
  joinRequests        CompanyJoinRequest[]
  auditActions        CompanyMemberAudit[] @relation("Actor")
  reviewsMade         CompanyJoinRequest[] @relation("Reviewer")
  adminsInvited       Admin[]              @relation("AdminInviter")

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("user")
}

model Admin {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName   String
  lastName    String
  type        AdminType @default(SUPER_ADMIN)
  invitedById String?
  invitedBy   User?     @relation("AdminInviter", fields: [invitedById], references: [id])
  invitedAt   DateTime? 
  permissions Json? 
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt

  @@index([type])
  @@index([invitedById])
  @@map("admin")
}

model Seeker {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName String
  lastName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("seeker")
}

model Company {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  website     String?
  logo        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  companyMembers CompanyMember[]
  invitations    Invitation[]         @relation("CompanyInvitations")
  joinRequests   CompanyJoinRequest[]
  auditLogs      CompanyMemberAudit[]

  @@index([name])
  @@index([createdAt])
  @@map("company")
}

model CompanyMember {
  id          String            @id @default(cuid())
  companyId   String
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        CompanyMemberRole
  department  String?
  title       String?
  permissions Json? 
  invitedById String? 
  invitedBy   User?             @relation("MemberInviter", fields: [invitedById], references: [id])
  invitedAt   DateTime?
  joinedAt    DateTime          @default(now())
  status      CompanyMemberStatus @default(ACTIVE)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @default(now()) @updatedAt

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
  @@index([role])
  @@index([status])
  @@index([createdAt])
  @@map("company_member")
}

model Invitation {
  id   String         @id @default(cuid())
  type InvitationType 

  companyId String? 
  company   Company? @relation("CompanyInvitations", fields: [companyId], references: [id], onDelete: Cascade)

  adminType      AdminType? 
  adminCompanyId String? 

  inviterId String 
  inviter   User   @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)

  inviteeId String? 
  invitee   User?   @relation("Invitee", fields: [inviteeId], references: [id])
  email     String 
  firstName String? 
  lastName  String? 

  role        String? 
  permissions Json? 
  department  String? 
  title       String? 

  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime         @default(dbgenerated("now() + interval '7 days'"))
  message    String? 
  acceptedAt DateTime?
  declinedAt DateTime?
  revokedAt  DateTime?

  ipAddress String? 
  userAgent String? 
  metadata  Json? 

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([companyId, email, type]) 
  @@unique([email, type, status]) 

  @@index([type])
  @@index([companyId])
  @@index([inviterId])
  @@index([inviteeId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([type, status])
  @@index([email, status])
  @@map("invitation")
}

model CompanyJoinRequest {
  id           String            @id @default(cuid())
  companyId    String
  company      Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId       String
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  message      String?
  status       JoinRequestStatus @default(PENDING)
  reviewedById String? 
  reviewedBy   User?             @relation("Reviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @default(now()) @updatedAt

  @@unique([companyId, userId, status]) 
  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([reviewedById])
  @@map("company_join_request")
}

model CompanyMemberAudit {
  id String @id @default(cuid())

  companyId String? 
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  memberId String? 
  actorId  String 
  actor    User    @relation("Actor", fields: [actorId], references: [id])

  actionType String 
  targetType String 
  targetId   String? 

  oldData Json? 
  newData Json? 
  changes Json? 

  ipAddress String?
  userAgent String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([actorId])
  @@index([memberId])
  @@index([actionType])
  @@index([targetType])
  @@index([createdAt])
  @@map("company_member_audit")
}
